#  소셜 로그인 완전 가이드

**난이도**: 중급  
**소요 시간**: 약 2-3시간

---

##  목차

1. [사전 준비사항](#1-사전-준비사항)
2. [Supabase 설정](#2-supabase-설정)
3. [플랫폼별 설정](#3-플랫폼별-설정)
4. [코드 구현](#4-코드-구현)
5. [테스트 및 검증](#5-테스트-및-검증)
6. [문제 해결](#6-문제-해결)

---

## 1. 사전 준비사항

### 1.1 필요한 계정

다음 계정들이 필요합니다 (무료 계정으로 시작 가능):

-  **Supabase 계정** (https://supabase.com) - 무료 플랜
-  **Google Cloud Console** (Google 로그인용) - 무료
-  **Apple Developer 계정** (Apple 로그인용) - 유료 (연간 $99)
-  **카카오 Developers 계정** (카카오 로그인용) - 무료
-  **네이버 Developers 계정** (네이버 로그인용) - 무료

### 1.2 개발 환경

- Flutter SDK 3.x 이상
- Dart SDK 3.x 이상
- Android Studio / Xcode
- 에뮬레이터 또는 실제 기기

### 1.3 프로젝트 설정 확인

- [ ] Supabase 프로젝트 생성 완료
- [ ] Flutter 프로젝트 생성 완료
- [ ] `supabase_flutter` 패키지 설치 완료

** 참고**: Supabase 프로젝트 생성은 `설정/Supabase_초기_설정_가이드.md` 참조

---

## 2. Supabase 설정

### 2.1 OAuth Provider 활성화

#### Step 1: Authentication 페이지 접속
1. Supabase 대시보드 접속
2. 프로젝트 선택
3. 좌측 메뉴에서 **Authentication** 클릭
4. **Providers** 탭 클릭

#### Step 2: Google OAuth 설정

**2-1. Google Cloud Console 설정**

1. [Google Cloud Console](https://console.cloud.google.com/) 접속
2. 프로젝트 선택 또는 새 프로젝트 생성
3. **API 및 서비스** → **사용자 인증 정보** 이동
4. **사용자 인증 정보 만들기** → **OAuth 클라이언트 ID** 클릭
5. **애플리케이션 유형**: `웹 애플리케이션` 선택
6. 다음 정보 입력:
   - **이름**: `Community App - Web` (원하는 이름)
   - **승인된 리디렉션 URI**: 
     ```
     https://[프로젝트-id].supabase.co/auth/v1/callback
     ```
     (Supabase Project URL + `/auth/v1/callback`)
7. **만들기** 클릭
8. 생성된 **클라이언트 ID**와 **클라이언트 보안 비밀번호** 복사

**2-2. Supabase에 Google OAuth 설정**

1. Supabase 대시보드 → **Authentication** → **Providers**
2. **Google** 찾기
3. **Enable Google provider** 토글 활성화
4. 다음 정보 입력:
   - **Client ID (for OAuth)**: Google Cloud Console에서 복사한 클라이언트 ID
   - **Client Secret (for OAuth)**: Google Cloud Console에서 복사한 클라이언트 보안 비밀번호
5. **Save** 클릭

#### Step 3: 카카오 OAuth 설정

**3-1. 카카오 Developers 설정**

1. [카카오 Developers](https://developers.kakao.com/) 접속
2. **내 애플리케이션** → **애플리케이션 추가하기** 클릭
3. 다음 정보 입력:
   - **앱 이름**: `Community App`
   - **사업자명**: 본인 이름
4. **저장** 클릭

**3-2. 카카오 로그인 활성화**

1. 생성한 앱 선택
2. **카카오 로그인** → **활성화 설정** 클릭
3. **활성화 상태**: ON으로 변경
4. **Redirect URI** 추가:
   ```
   https://[프로젝트-id].supabase.co/auth/v1/callback
   ```
5. **저장** 클릭

**3-3. REST API 키 확인**

1. **앱 키** 메뉴 클릭
2. **REST API 키** 복사

**3-4. Supabase에 카카오 OAuth 설정**

1. Supabase 대시보드 → **Authentication** → **Providers**
2. **Kakao** 찾기
3. **Enable Kakao provider** 토글 활성화
4. 다음 정보 입력:
   - **Client ID (REST API Key)**: 카카오 Developers에서 복사한 REST API 키
5. **Save** 클릭

#### Step 4: 네이버 OAuth 설정

**4-1. 네이버 Developers 설정**

1. [네이버 Developers](https://developers.naver.com/) 접속
2. **애플리케이션** → **애플리케이션 등록** 클릭
3. 다음 정보 입력:
   - **애플리케이션 이름**: `Community App`
   - **사용 API**: `네이버 로그인` 선택
   - **로그인 오픈 API 서비스 환경**: `PC 웹` 선택
   - **서비스 URL**: `http://localhost:3000` (또는 실제 도메인)
   - **Callback URL**: 
     ```
     https://[프로젝트-id].supabase.co/auth/v1/callback
     ```
4. **등록하기** 클릭

**4-2. 클라이언트 ID와 Secret 확인**

1. 생성한 애플리케이션 선택
2. **Client ID**와 **Client Secret** 복사

**4-3. Supabase에 네이버 커스텀 OAuth 설정**

 **중요**: Supabase는 네이버를 기본 제공하지 않으므로 **커스텀 OAuth provider**로 설정해야 합니다.

1. Supabase 대시보드 → **Authentication** → **Providers**
2. **Add a new provider** 또는 **Custom OAuth** 찾기
3. **Custom OAuth** 선택 (또는 **Add custom provider** 클릭)
4. 다음 정보 입력:
   - **Provider Name**: `naver` (소문자로 정확히 입력)
   - **Client ID (for OAuth)**: 네이버 Developers에서 복사한 Client ID
   - **Client Secret (for OAuth)**: 네이버 Developers에서 복사한 Client Secret
   - **Authorization URL**: `https://nid.naver.com/oauth2.0/authorize`
   - **Token URL**: `https://nid.naver.com/oauth2.0/token`
   - **User Info URL**: `https://openapi.naver.com/v1/nid/me`
   - **Scopes**: `email` (필요에 따라 추가 가능)
5. **Save** 클릭

### 2.2 Redirect URL 설정

#### Step 1: URL Configuration 접속
1. Supabase 대시보드 → **Authentication** → **URL Configuration** 클릭

#### Step 2: Redirect URLs 추가
다음 URL들을 추가하세요:

```
com.example.communityapp://callback
com.example.communityapp://
```

** 중요**: `com.example.communityapp`을 실제 앱 번들 ID로 변경하세요.

#### Step 3: Site URL 확인
Site URL이 올바르게 설정되어 있는지 확인:
```
http://localhost:3000
```
(또는 실제 도메인)

---

## 3. 플랫폼별 설정

### 3.1 Android 설정

#### Step 1: AndroidManifest.xml 수정

파일 위치: `android/app/src/main/AndroidManifest.xml`

`<activity>` 태그 안에 다음을 추가:

```xml
<activity
    android:name=".MainActivity"
    ...>
    <!-- 기존 내용 -->
    
    <!-- Deep Linking 설정 -->
    <intent-filter>
        <action android:name="android.intent.action.VIEW" />
        <category android:name="android.intent.category.DEFAULT" />
        <category android:name="android.intent.category.BROWSABLE" />
        <data
            android:scheme="com.example.communityapp"
            android:host="callback" />
    </intent-filter>
</activity>
```

** 중요**: `com.example.communityapp`을 실제 앱 번들 ID로 변경하세요.

### 3.2 iOS 설정

#### Step 1: Info.plist 수정

파일 위치: `ios/Runner/Info.plist`

`<dict>` 태그 안에 다음을 추가:

```xml
<key>CFBundleURLTypes</key>
<array>
    <dict>
        <key>CFBundleTypeRole</key>
        <string>Editor</string>
        <key>CFBundleURLName</key>
        <string>com.example.communityapp</string>
        <key>CFBundleURLSchemes</key>
        <array>
            <string>com.example.communityapp</string>
        </array>
    </dict>
</array>
```

** 중요**: `com.example.communityapp`을 실제 앱 번들 ID로 변경하세요.

#### Step 2: Google Cloud Console iOS 설정 (선택사항)

iOS에서도 Google 로그인이 작동하지만, iOS 클라이언트 ID를 추가로 생성할 수 있습니다:

1. Google Cloud Console → **API 및 서비스** → **사용자 인증 정보**
2. **사용자 인증 정보 만들기** → **OAuth 클라이언트 ID**
3. **애플리케이션 유형**: iOS 선택
4. **번들 ID**: `com.example.communityapp` (실제 번들 ID)
5. **생성** 클릭

**참고**: Supabase Web OAuth를 사용하는 경우, 웹 클라이언트 ID만 있어도 iOS에서 정상 작동합니다.

---

## 4. 코드 구현

### 4.1 패키지 설치

`pubspec.yaml`에 다음 패키지 추가:

```yaml
dependencies:
  supabase_flutter: ^2.9.2
  flutter_dotenv: ^5.1.0
  url_launcher: ^6.3.1
```

터미널에서 설치:
```bash
flutter pub get
```

### 4.2 환경 변수 설정

#### Step 1: .env 파일 생성

프로젝트 루트에 `.env` 파일 생성:

```env
SUPABASE_URL=https://[프로젝트-id].supabase.co
SUPABASE_ANON_KEY=[anon public key]
REDIRECT_URL=com.example.communityapp://callback
```

** 중요**: 
- `[프로젝트-id]`를 실제 Supabase 프로젝트 ID로 변경
- `[anon public key]`를 Supabase 대시보드에서 복사한 anon public key로 변경
- `com.example.communityapp`을 실제 앱 번들 ID로 변경

#### Step 2: .gitignore 추가

`.gitignore`에 `.env` 추가 (선택사항, 보안을 위해):

```
.env
```

### 4.3 Supabase 초기화

#### 파일: `lib/core/services/external/supabase_service.dart`

```dart
import 'package:flutter_dotenv/flutter_dotenv.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

class SupabaseService {
  static late final SupabaseClient client;
  
  static Future<void> initialize() async {
    await dotenv.load(fileName: ".env");
    
    final url = dotenv.env['SUPABASE_URL']!;
    final anonKey = dotenv.env['SUPABASE_ANON_KEY']!;
    
    await Supabase.initialize(
      url: url,
      anonKey: anonKey,
    );
    
    client = Supabase.instance.client;
  }
  
  static User? get currentUser => client.auth.currentUser;
  static Session? get currentSession => client.auth.currentSession;
}
```

### 4.4 OAuth 로그인 서비스

#### 파일: `lib/core/services/internal/auth_provider_service.dart`

```dart
import 'dart:io';
import 'package:flutter_dotenv/flutter_dotenv.dart';
import 'package:lionsns/features/auth/domain/user.dart';
import 'package:supabase_flutter/supabase_flutter.dart' hide User;
import 'package:supabase_flutter/supabase_flutter.dart' as supabase show User;
import 'package:url_launcher/url_launcher.dart';
import '../../utils/result.dart';
import '../external/supabase_service.dart';

class AuthProviderService {
  static Future<Result<AuthResponse>> loginWithGoogle() async {
    try {
      final redirectUrl = dotenv.env['REDIRECT_URL'];
      if (redirectUrl == null) {
        throw Exception('Redirect URL이 설정되지 않았습니다. .env 파일을 확인하세요.');
      }
      
      await SupabaseService.client.auth.signInWithOAuth(
        OAuthProvider.google,
        redirectTo: redirectUrl,
        authScreenLaunchMode: LaunchMode.platformDefault,
      );
      
      return Pending<AuthResponse>('OAuth 로그인이 진행중입니다. 브라우저에서 로그인을 완료해주세요!');
    } catch (e) {
      return Failure<AuthResponse>('Google 로그인에 실패했습니다: $e');
    }
  }

  static Future<Result<AuthResponse>> loginWithKakao() async {
    try {
      final redirectUrl = dotenv.env['REDIRECT_URL'];
      if (redirectUrl == null) {
        throw Exception('Redirect URL이 설정되지 않았습니다. .env 파일을 확인하세요.');
      }
      
      await SupabaseService.client.auth.signInWithOAuth(
        OAuthProvider.kakao,
        redirectTo: redirectUrl,
        authScreenLaunchMode: LaunchMode.platformDefault,
      );
      
      return Pending<AuthResponse>('OAuth 로그인이 진행중입니다. 브라우저에서 로그인을 완료해주세요!');
    } catch (e) {
      return Failure<AuthResponse>('카카오 로그인에 실패했습니다: $e');
    }
  }

  static Future<Result<AuthResponse>> loginWithNaver() async {
    try {
      final redirectUrl = dotenv.env['REDIRECT_URL'];
      final supabaseUrl = dotenv.env['SUPABASE_URL'];
      if (redirectUrl == null || supabaseUrl == null) {
        throw Exception('Redirect URL 또는 Supabase URL이 설정되지 않았습니다. .env 파일을 확인하세요.');
      }
      
      // Supabase 커스텀 OAuth provider 사용
      // Supabase 대시보드에서 "naver"라는 이름으로 커스텀 OAuth provider를 설정해야 합니다.
      // 커스텀 provider는 직접 OAuth URL을 구성하여 사용합니다.
      final customProviderUrl = '$supabaseUrl/auth/v1/authorize?provider=naver&redirect_to=$redirectUrl';
      
      // URL을 브라우저로 열기
      final uri = Uri.parse(customProviderUrl);
      if (await canLaunchUrl(uri)) {
        await launchUrl(
          uri,
          mode: LaunchMode.platformDefault,
        );
        return Pending<AuthResponse>('OAuth 로그인이 진행중입니다. 브라우저에서 로그인을 완료해주세요!');
      } else {
        throw Exception('URL을 열 수 없습니다: $customProviderUrl');
      }
    } catch (e) {
      return Failure<AuthResponse>('네이버 로그인에 실패했습니다: $e');
    }
  }

  static User authResponseToUser(AuthResponse authResponse) {
    final user = authResponse.user;
    if (user == null) {
      throw Exception('사용자 정보가 없습니다.');
    }
    
    final userMetadata = user.userMetadata ?? {};
    return User(
      id: user.id,
      name: userMetadata['full_name'] as String? ??
          userMetadata['name'] as String? ??
          (user.email?.split('@')[0] ?? '사용자'),
      email: user.email ?? '',
      profileImageUrl: userMetadata['avatar_url'] as String?,
      provider: _getProviderFromSupabaseUser(user),
      createdAt: DateTime.parse(user.createdAt),
    );
  }

  static AuthProvider _getProviderFromSupabaseUser(supabase.User supabaseUser) {
    final appMetadata = supabaseUser.appMetadata;
    final provider = appMetadata['provider'] as String? ?? 'email';

    switch (provider) {
      case 'google':
        return AuthProvider.google;
      case 'kakao':
        return AuthProvider.kakao;
      case 'naver':
        return AuthProvider.naver;
      default:
        return AuthProvider.google;
    }
  }
}
```

### 4.5 main.dart 수정

#### 파일: `lib/main.dart`

```dart
import 'package:flutter/material.dart';
import 'package:lionsns/core/services/external/supabase_service.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  
  // Supabase 초기화
  await SupabaseService.initialize();
  
  // Deep Linking 처리
  SupabaseService.client.auth.onAuthStateChange.listen((data) {
    if (data.event == AuthChangeEvent.signedIn) {
      print(' 로그인 성공');
    }
  });
  
  runApp(MyApp());
}
```

### 4.6 로그인 화면 구현

#### 파일: `lib/features/auth/presentation/pages/auth_screen.dart`

```dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../viewmodels/auth_viewmodel.dart';

class AuthScreen extends ConsumerWidget {
  const AuthScreen({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final authResult = ref.watch(authViewModelProvider);
    final viewModel = ref.read(authViewModelProvider.notifier);

    return Scaffold(
      body: authResult.when(
        success: (user) => user == null 
          ? _buildLoginButtons(context, viewModel)
          : _buildLoggedInView(user),
        failure: (message, _) => _buildError(message),
        pending: (_) => _buildLoading(),
      ),
    );
  }

  Widget _buildLoginButtons(BuildContext context, AuthViewModel viewModel) {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          ElevatedButton(
            onPressed: () => viewModel.signIn(AuthProvider.google),
            child: Text('Google로 로그인'),
          ),
          SizedBox(height: 16),
          ElevatedButton(
            onPressed: () => viewModel.signIn(AuthProvider.kakao),
            child: Text('카카오로 로그인'),
          ),
          SizedBox(height: 16),
          ElevatedButton(
            onPressed: () => viewModel.signIn(AuthProvider.naver),
            child: Text('네이버로 로그인'),
          ),
        ],
      ),
    );
  }

  Widget _buildLoggedInView(User user) {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Text('로그인 성공!'),
          Text('이름: ${user.name}'),
          Text('이메일: ${user.email}'),
        ],
      ),
    );
  }

  Widget _buildError(String message) {
    return Center(
      child: Text('오류: $message'),
    );
  }

  Widget _buildLoading() {
    return Center(
      child: CircularProgressIndicator(),
    );
  }
}
```

---

## 5. 테스트 및 검증

### 5.1 테스트 순서

1. **앱 실행**
   ```bash
   flutter run
   ```

2. **로그인 버튼 클릭**
   - Google 또는 카카오 로그인 버튼 클릭

3. **브라우저에서 로그인**
   - 외부 브라우저가 열리고 SNS 로그인 페이지 표시
   - 계정으로 로그인

4. **앱으로 자동 리다이렉트**
   - 로그인 완료 후 앱으로 자동 돌아옴

5. **로그인 성공 확인**
   - 콘솔에 " 로그인 성공" 메시지 확인
   - 화면에 사용자 정보 표시 확인

### 5.2 디버깅 방법

**로그 확인**:
- Flutter 콘솔에서 로그인 성공 메시지 확인
- Supabase 대시보드 → **Authentication** → **Users**에서 사용자 확인

**Supabase 대시보드 확인**:
1. **Authentication** → **Users** 탭
2. 로그인한 사용자 확인
3. **Logs** 탭에서 인증 이벤트 확인

---

## 6. 문제 해결

### 오류 1: "Invalid redirect URL"

**원인**: Supabase 대시보드의 Redirect URL 설정이 잘못됨

**해결**:
1. Supabase 대시보드 → **Authentication** → **URL Configuration** 확인
2. Redirect URLs에 `com.example.communityapp://callback` 추가
3. 앱 재시작

### 오류 2: "OAuth provider not enabled"

**원인**: Supabase 대시보드에서 OAuth Provider가 활성화되지 않음

**해결**:
1. Supabase 대시보드 → **Authentication** → **Providers** 확인
2. 사용할 Provider (Google, Kakao 등) 토글 활성화
3. Client ID와 Secret 입력 확인
4. **Save** 클릭

### 오류 3: Deep Linking이 작동하지 않음

**원인**: AndroidManifest.xml 또는 Info.plist 설정이 잘못됨

**해결**:

**Android**:
1. `AndroidManifest.xml`의 `intent-filter` 확인
2. `android:scheme`과 `android:host` 값 확인
3. 앱 재설치

**iOS**:
1. `Info.plist`의 `CFBundleURLSchemes` 확인
2. Xcode에서 **Runner** → **Info** → **URL Types** 확인
3. 앱 재설치

### 오류 4: "redirect_uri_mismatch"

**원인**: Google Cloud Console의 리디렉션 URI와 Supabase 설정이 일치하지 않음

**해결**:
1. Google Cloud Console → **사용자 인증 정보** → **OAuth 클라이언트 ID** 선택
2. **승인된 리디렉션 URI**에 다음 추가:
   ```
   https://[프로젝트-id].supabase.co/auth/v1/callback
   ```
3. Supabase 대시보드 → **URL Configuration**에서 Redirect URLs 확인
4. 앱 재시작

### 오류 5: ".env 파일을 찾을 수 없음"

**원인**: `.env` 파일이 없거나 경로가 잘못됨

**해결**:
1. 프로젝트 루트에 `.env` 파일 생성
2. `.env` 파일 내용 확인
3. `flutter pub get` 실행

---

## 7. 다음 단계

소셜 로그인 설정이 완료되면:

1.  [Supabase 초기 설정 가이드](./Supabase_초기_설정_가이드.md) - 데이터베이스 설정
2.  [Storage 초기 설정 가이드](./Storage/초기_설정_가이드.md) - 이미지 업로드 설정
3.  [푸시 알림 완전 가이드](./푸시_알림_완전_가이드.md) - 푸시 알림 설정 (선택사항)

---

## 8. 참고 자료

- [Supabase OAuth 문서](https://supabase.com/docs/guides/auth/social-login/auth-google)
- [Google OAuth 설정 가이드](https://developers.google.com/identity/protocols/oauth2)
- [카카오 로그인 가이드](https://developers.kakao.com/docs/latest/ko/kakaologin/common)
- [Flutter Deep Linking 가이드](https://docs.flutter.dev/development/ui/navigation/deep-linking)

---

